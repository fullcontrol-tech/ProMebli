document.addEventListener('DOMContentLoaded', function () {
    // Мобільне меню
    const navMenu = document.getElementById('nav-menu');
    const navToggle = document.getElementById('nav-toggle');
    const navClose = document.getElementById('nav-close');
    
    // Відкриття меню
    if (navToggle) {
        navToggle.addEventListener('click', () => {
            navMenu.classList.add('active');
            navToggle.classList.add('hidden'); // Приховуємо бургер
            document.body.style.overflow = 'hidden'; // Блокуємо скрол
        });
    }
    
    // Функція закриття меню
    function closeMenu() {
        navMenu.classList.remove('active');
        navToggle.classList.remove('hidden'); // Повертаємо бургер
        document.body.style.overflow = ''; // Повертаємо скрол
    }
    
    // Закриття меню через кнопку закриття
    if (navClose) {
        navClose.addEventListener('click', closeMenu);
    }
    
    // Закриття меню при кліку на ссилки
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', closeMenu);
    });
    
    // Закриття меню при кліку поза меню
    document.addEventListener('click', (e) => {
        if (navMenu.classList.contains('active') && 
            !navMenu.contains(e.target) && 
            !navToggle.contains(e.target)) {
            closeMenu();
        }
    });

    // --- Слайдер портфоліо ---
    const portfolioSlider = new Swiper('#portfolio-slider', {
        loop: true,
        slidesPerView: 1.2,
        spaceBetween: 20,
        centeredSlides: true,
        grabCursor: true,
        navigation: {
            nextEl: '#portfolio-slider .swiper-button-next',
            prevEl: '#portfolio-slider .swiper-button-prev',
        },
        pagination: {
            el: '.swiper-pagination',
            enabled: false,
        },
        breakpoints: {
            576: {
                slidesPerView: 2
            },
            768: {
                slidesPerView: 2.5,
                spaceBetween: 30,
                centeredSlides: false
            },
            1200: {
                slidesPerView: 3.5,
                spaceBetween: 40,
                centeredSlides: false
            }
        }
    });

    // --- Слайдер відгуків ---
    const testimonialsSlider = new Swiper('#testimonials-slider', {
        slidesPerView: 1,
        spaceBetween: 30,
        loop: true,
        autoplay: {
            delay: 5000,
            disableOnInteraction: false,
        },
        navigation: {
            nextEl: '#testimonials-slider .swiper-button-next',
            prevEl: '#testimonials-slider .swiper-button-prev',
        },
        pagination: {
            el: '.swiper-pagination',
            enabled: false,
        },
        breakpoints: {
            768: {
                slidesPerView: 2,
            },
            1024: {
                slidesPerView: 3,
            },
        }
    });

    // --- ОБРОБНИК ФОРМИ ---
    const leadForm = document.getElementById('leadForm');
    
    if (leadForm) {
        leadForm.addEventListener('submit', function (event) {
            // Не блокуємо стандартну відправку — пошта піде через FormSubmit
            sendTelegram();
            
            // Facebook Pixel Lead event
            if (typeof fbq === 'function') {
                fbq('track', 'Lead');
            }

            // Задаємо затримку перед редіректом, щоб форма встигла відправитись
            setTimeout(function() {
                window.location.href = 'thank-you.html';
            }, 500); // 0.5 секунди
        });
    }

    function sendTelegram() {
        const name = document.querySelector('input[name="name"]').value.trim();
        const phone = document.querySelector('input[name="phone"]').value.trim();

        if (!name || !phone) return; // Без даних не відправляємо

        const message = `🔥 Нова заявка!\n👤 Ім'я: ${name}\n📞 Телефон: ${phone}`;

        const botToken = '7747442953:AAG_uTeisUybcX-mdhPJbvHSkj2sQi3M8JA';
        const chatId = '-1002821902695';

        const url = `https://api.telegram.org/bot${botToken}/sendMessage`;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                chat_id: chatId,
                text: message
            })
        }).then(response => {
            if (!response.ok) {
                console.error('Telegram API error:', response.statusText);
            }
        }).catch(error => {
            console.error('Telegram fetch error:', error);
        });
    }

    // --- FAQ розкривні елементи ---
    const faqQuestions = document.querySelectorAll('.faq-question');

    faqQuestions.forEach(question => {
        question.addEventListener('click', () => {
            const faqItem = question.parentElement;
            const answer = question.nextElementSibling;
            
            // Закриваємо всі інші відповіді
            faqQuestions.forEach(q => {
                if (q !== question) {
                    q.classList.remove('active');
                    q.nextElementSibling.classList.remove('active');
                }
            });
            
            // Перемикаємо активний стан для поточного питання
            question.classList.toggle('active');
            answer.classList.toggle('active');
        });
    });

    // ЛОГІКА ДЛЯ ПРОСТОЇ І СТАБІЛЬНОЇ ГАЛЕРЕЇ
    const projectModal = document.getElementById('project-modal');
    const portfolioItems = document.querySelectorAll('.portfolio-item');
    
    if (projectModal && portfolioItems.length > 0) {
        const modalImage = document.getElementById('modal-image');
        const modalCounter = document.getElementById('modal-counter');
        const modalPrevBtn = document.getElementById('modal-prev');
        const modalNextBtn = document.getElementById('modal-next');

        let currentImages = [];
        let currentIndex = 0;

        // Функція для оновлення вигляду галереї
        function updateModalView() {
            modalImage.classList.remove('active');
            
            // Плавна зміна зображення
            setTimeout(() => {
                modalImage.src = currentImages[currentIndex];
                modalImage.onload = () => {
                    modalImage.classList.add('active');
                };
            }, 100);

            // Оновлення лічильника
            modalCounter.textContent = `${currentIndex + 1} / ${currentImages.length}`;

            // Приховування/показ кнопок та лічильника
            const showControls = currentImages.length > 1;
            modalPrevBtn.style.display = showControls ? 'block' : 'none';
            modalNextBtn.style.display = showControls ? 'block' : 'none';
            modalCounter.style.display = showControls ? 'block' : 'none';
        }

        // Навішуємо обробник на кожну картку проекту
        portfolioItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const data = e.currentTarget.dataset;
                
                // Збираємо дані для галереї
                currentImages = data.images ? data.images.split(',').map(url => url.trim()) : [item.querySelector('img').src];
                currentIndex = 0;

                // Заповнюємо інформацію про проект
                document.getElementById('modal-title').textContent = data.title;
                document.getElementById('modal-date').textContent = data.date;
                document.getElementById('modal-description').textContent = data.description;
                
                // Оновлюємо вигляд галереї і показуємо модальне вікно
                updateModalView();
                document.body.classList.add('modal-open');
                projectModal.classList.add('visible');
            });
        });

        // Навігація в галереї
        modalNextBtn.addEventListener('click', () => {
            currentIndex = (currentIndex + 1) % currentImages.length;
            updateModalView();
        });

        modalPrevBtn.addEventListener('click', () => {
            currentIndex = (currentIndex - 1 + currentImages.length) % currentImages.length;
            updateModalView();
        });

        // Закриття модального вікна
        const closeModal = () => {
            document.body.classList.remove('modal-open');
            projectModal.classList.remove('visible');
        };
        
        document.getElementById('modal-close').addEventListener('click', closeModal);
        
        projectModal.addEventListener('click', (e) => {
            if (e.target === projectModal) {
                closeModal();
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === "Escape") {
                closeModal();
            }
        });
    }
});